

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>当你打开终端并输入命令时会发生什么?（上） [ 咸鱼运维杂谈 ]</title>

  <link rel="icon" href="/img/favicon.ico">


    <meta name="author" content="Ammon">



    <meta name="Description" content="404NotFound">



  <link rel="alternate" href="/atom.xml " title="咸鱼运维杂谈" type="application/atom+xml">


  
    <link rel="stylesheet" href="/css/main.css">
  

</head>
  <body data-theme="light" class="notransition">
    <script>
      const body = document.body;
      const data = body.getAttribute("data-theme");
      const initTheme = (state) => {
        if (state === "dark") {
          body.setAttribute("data-theme", "dark");
        } else if (state === "light") {
          body.removeAttribute("data-theme");
        } else {
          localStorage.setItem("theme", data);
        }
      };
   
      initTheme(localStorage.getItem("theme"));
      
      setTimeout(() => body.classList.remove("notransition"), 75);
    </script>
  <div class="navbar" role="navigation">
    <nav class="menu">
      <input type="checkbox" id="menu-trigger" class="menu-trigger" />
      <label for="menu-trigger">
        <span class="menu-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 512 512"
          >
            <path
              d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"
            />
          </svg>
        </span>
      </label>
      <a id="mode">
        <svg
          class="mode-sunny"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>LIGHT</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
        <svg
          class="mode-moon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>DARK</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
      </a>
      <div class="trigger">
        <div class="trigger-container">
          
            
            
            
            
            
            
            <a class="menu-link " href="/"> Home</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/about/"> About</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/archives/"> Archives</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/tags/"> Tags</a>
          
        </div>
      </div>
    </nav>
  </div>
  
<div class="wrapper post">
  <main class="page-content" aria-label="Content">
      <header class="header">
        
          <div class="tags">
            <a href="/tags/Linux/" class="tag"># Linux</a>
          </div>
        
        <h1 class="header-title" itemprop="headline">当你打开终端并输入命令时会发生什么?（上）</h1>
          <div class="post-meta">
            <time>4月 29, 2024</time>
            <span itemprop="author">
              <span itemprop="name">Ammon</span>
            </span>
          </div>
        </header>

          <div class="page-content"><p>哈喽大家好，我是咸鱼</p>
<p>参加过校招面试的小伙伴们肯定对下面这道面试题很熟悉：“当你在浏览器输入一段网址后会发生什么？”。这道面试题可以说是很经典了，因为其涉及大量网络协议，可以非常直观的看出小伙伴们对计算机网络体系的整体把握程度</p>
<p>但如果问题换成：“当你打开终端并输入 <code>ls</code>  时会发生什么？”，有多少小伙伴能够回答出来呢？</p>
<h2 id="终端的前世今生"><a href="#终端的前世今生" class="headerlink" title="终端的前世今生"></a>终端的前世今生</h2><p>大多数现代终端应用程序的工作方式都来自于其历史前辈——电传打字机（teletypes，简称 tty）</p>
<p>在大型计算机的时代，当时数据存储在磁带上，计算机的内存以 kB 为单位，电传打字机就是为了它们而被设计出来</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213141137888.png" class="" title="image-20231213141137888">



<p>如上图，左边的是 IBM 2741电传打字机，右边是 IBM System&#x2F;360 Mo. 40大型计算机</p>
<p>电传打字机是允许用户与计算机交互的基本文本客户端。teletypes 其实是 teletypewriter的缩写，因为它是从打字机（typewriters）演变过来的</p>
<p>如上图所示，电传打字机和大型计算机通过连接两端的物理线来进行通信。沟通过程如下：</p>
<ul>
<li>当用户从电传打字机输入时，ASCII 文本将一个字符一个字符地通过网络传输</li>
<li>计算机的内核接收字符并对其进行解码</li>
<li>接着字符被送到一个名为 <strong>TTY driver</strong> 的驱动程序，这里负责将输入发送到用户程序并收集输出</li>
<li>最后，内核将输出发送回电传打字机 ，以便显示给用户</li>
</ul>
<p>需要提到的一点是 <strong>line discipline</strong>（行规则），它会将字符缓冲到内核内存中，直到按下 Enter” 键，程序才会接收到输入</p>
<p>line discipline 允许这块缓冲区是可编辑的，并提供了一些与程序无关的快捷键（例如 ctrl-w）</p>
<p>这在当时是一项重要的性能优化，因为让程序员一个字符一个字符的处理是非常低效的</p>
<p>随着计算技术的进步，这些独立组件中的许多都实现了现代化。比如说电传打字机被终端所取代，终端是完全电子的机器，包括电子显示器</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213144235793.png" class="" title="image-20231213144235793">



<p>上图是 DEC 于 1978 年发布的 VT100 终端机（VT &#x3D; video terminal），它实现并推广了至今仍在使用的 ANSI 转义码</p>
<p>随着电子终端的诞生，出现了越来越多的功能（例如颜色、铃声）。但本质上跟电传打字机完全相同——<strong>发送输入字符流并显示输出</strong></p>
<p>现如今人人都有一台自己的电脑，这些电脑的操作系统可以监督许多应用程序，终端不再是专门的硬件，而是变成了这些应用程序中的一个</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213144850897.png" class="" title="image-20231213144850897">



<p>与典型的 GUI 应用程序一样，终端是操作系统监督下的一个进程，它监听来自用户的事件和输入，并告诉操作系统在窗口中显示什么（终端不直接与外设交互，而是通过驱动程序和窗口管理器）</p>
<p>有时候我们还会听到 ”终端模拟器“ 这个词，而不是简单的称之为 ”终端“。这是因为 ”终端“ 指的是专门的硬件（终端机），而现在大多数的终端只是对该设备的模拟，是一个应用程序</p>
<p>但是我们这里不做区分，”终端模拟器“ 和 ”终端“ 含义一样</p>
<p>那么当我们打开终端时会发生什么呢？</p>
<h2 id="打开终端"><a href="#打开终端" class="headerlink" title="打开终端"></a>打开终端</h2><p>上面我们提到过，终端是一个应用程序，能够让你 ”使用你的电脑“（即在上面运行程序）。我们的电脑上可能已经存在了 <code>ls、rm、mv</code> 等程序</p>
<p>但是我们不满足于使用这些简单的命令，我们还希望使用脚本来实现自动化， 这些脚本将许多命令的序列组合在一起，使用分支条件逻辑，运行重复循环或并行化命令等</p>
<p>为了让计算机能够读懂我们的脚本并执行起来，我们需要一个完整的可交互的解释型的编程环境——shell</p>
<p>将其他程序作为进程运行，让操作系统内核读懂你写的脚本，这些工作都由 shell 完成。目前常见的 shell 有 Bash、Zsh 等</p>
<p>终端和 shell 是两个独立的程序：</p>
<ul>
<li>shell 负责解释你输入的命令</li>
<li>终端负责 UI 相关的东西，比如字体、颜色等</li>
</ul>
<p>当我们打开终端时，终端会根据用户生成一个 shell 进程，以及用户与 shell 之间，用户与 shell 启动的进程之间通信的方法</p>
<p>这个 shell 进程负责解释和执行用户输入的命令，并与用户进行交互。用户在终端输入的命令将通过这个通信通道传递给 shell 进程进行解释执行，并将执行结果反馈给用户显示在终端上</p>
<p><strong>创建 PTY</strong></p>
<p>伪终端设备（PTY）是在计算机操作系统中创建的一个虚拟设备，用于模拟物理终端的功能</p>
<p>在 UNIX、Linux 和类 UNIX 系统中，PTY 用于在用户和程序之间建立一个通信通道，允许用户通过终端会话与程序进行交互</p>
<p>PTY通常由两个主要部分组成：主设备（leader）和从设备（follower）。leader端连接到用户终端，follower端连接到一个或多个程序</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213154143142.png" class="" title="image-20231213154143142">



<p>当用户打开终端并启动一个 shell 时，终端模拟器会创建一个 PTY，并将 leader 端连接到用户界面，同时将 follower 端连接到 shell 或其他命令行程序。</p>
<p>用户输入的命令通过 leader 端传输到 follower 端，follower 端执行这些命令并将输出发送回 leader 端，最终显示在用户界面上</p>
<p><strong>在 Unix 中，一切皆文件</strong>，这句话指的是 Unix 中的所有东西都有与文件相同的读&#x2F;写接口。leader 的 fd（文件描述符） 指向内存中的一个缓冲区，而 follower 是一个在磁盘上具有实际路径的字符设备文件。</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213153442043.png" class="" title="image-20231213153442043">



<p>上图可以看到，我们打开了两个终端（&#x2F;dev&#x2F;pts&#x2F;0、&#x2F;dev&#x2F;pts&#x2F;1），启动了两个 shell 进程。如果我们在终端1（&#x2F;dev&#x2F;pts&#x2F;1）中敲命令并重定向到终端0（&#x2F;dev&#x2F;pts&#x2F;0），可以看到输出结果是在终端0中显示的</p>
<p><strong>生成 shell</strong></p>
<p>终端会话在启动时可能会为shell创建一个子进程，这个子进程将作为 shell 的实例来执行用户的命令</p>
<p>UNIX 和类 UNIX 系统中，终端会话会使用伪终端设备（PTY）来与 shell 进程进行通信，通过这种方式，终端会话可以读取和写入 shell 的输入、输出和错误输出（fd 0到2）</p>
<img src="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8A%EF%BC%89/image-20231213154145927.png" class="" title="image-20231213154145927">



<p><strong>shell 初始化</strong></p>
<p>在Linux中，用户打开终端启动 shell 进程时会进行 shell 初始化，这个过程涉及一些配置文件和脚本的执行，用来设置用户的环境和启动 shell 的行为</p>
<p>步骤大致如下：</p>
<ol>
<li><strong>读取配置文件</strong>：在用户登录时，shell 会读取一系列的配置文件来设置用户的环境变量、别名、函数等。这些配置文件可以包括全局配置文件（例如<code>/etc/profile</code>）和用户特定的配置文件（例如<code>~/.bash_profile</code>、<code>~/.bashrc</code>等）</li>
<li><strong>执行配置命令</strong>：配置文件中可以包含各种设置和命令，例如设置环境变量、修改提示符、定义别名和函数等。这些命令会在 shell 启动时执行，以确保在用户登录后设置了所需的环境和行为</li>
<li><strong>启动shell</strong>：一旦执行了配置文件中的命令，shell 就会准备就绪，等待用户的输入。这时，shell 的提示符会出现，等待用户输入命令。</li>
</ol>
</div>
          <nav class="post-nav">
    
    <a class="post-nav-item post-nav-prev" href="/2024/04/29/Kafka-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E7%9A%84%E5%85%A8%E5%B1%80%E9%A1%BA%E5%BA%8F%E6%80%A7/">
      <div class="nav-arrow">&lt;&nbsp;NEWER</div>
      <span class="post-title">Kafka 如何保证消息消费的全局顺序性</span>
    </a>
    
    
    <a class="post-nav-item post-nav-next" href="/2024/04/29/%E5%BD%93%E4%BD%A0%E6%89%93%E5%BC%80%E7%BB%88%E7%AB%AF%E5%B9%B6%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E6%97%B6%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88-%EF%BC%88%E4%B8%8B%EF%BC%89/">
      <div class="nav-arrow">OLDER&nbsp;&gt;</div>
      <span class="post-title">当你打开终端并输入命令时会发生什么?（下）</span>
    </a>
    
  </nav>
          <div class="dis">
    
     
    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: '' == 'true',
            verify: '' == 'true',
            appId: "BtErEBHVfpv2sxm8KWPywL1j-gzGzoHsz",
            appKey: "pmLLxXJE5OT872Kb8HMizMtj",
            avatar: "/img/redcat.jpg",
            placeholder: "说点什么吧！",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
		console.log("Valine done!")
		 
    </script>
    <!-- Valine Comments end -->

  </div>

   </main>
</div>

  <footer class="footer">
    <small class="footer_copyright">
      <div id="bottom-inner">
        Site by Ammon using
        <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>.
        <br>
        <p> Theme is <a target="_blank" rel="noopener" href="https://github.com/dewjohn/hexo-theme-klise">Klise</a></p>
      </div>
    </small>
  </footer>
  
  

    
      <script src="/js/main.js"></script>
    
  
  <script>
    window.FPConfig = {
      delay: 0,
      ignoreKeywords: [],
      maxRPS: 3,
      hoverDelay: 50,
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>
</body>
</html>
